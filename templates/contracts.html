{% extends "base.html" %}
{% block title %}Contracts{% endblock %}
{% block content %}
<div class="container">
    <h2 class="mb-4">Contracts</h2>
    
    <!-- Search input for filtering -->
    <input type="text" id="searchInput" class="form-control mb-3" placeholder="Search contracts..." onkeyup="filterTable()">
    
    <!-- Contracts table with an id for filtering -->
    <table class="table table-striped" id="dataTable">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Contract Name</th>
                <th>Supplier</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Total Value (£)</th>
                <th>Payment Frequency</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for contract in contracts %}
            <tr>
                <td>{{ contract[0] }}</td> <!-- Contract ID -->
                <td>
                    <a href="#" data-bs-toggle="modal" data-bs-target="#contractModal{{ contract[0] }}">
                        {{ contract[1] }} <!-- Contract Name -->
                    </a>
                </td>
                <td>{{ contract[2] }}</td> <!-- Supplier Name -->
                <td>{{ contract[3] }}</td> <!-- Start Date -->
                <td>{{ contract[4] }}</td> <!-- End Date -->
                <td>£{{ "%.2f"|format(contract[5]) }}</td> <!-- Total Value -->
                <td>{{ contract[6] }}</td> <!-- Payment Frequency -->
                <td>
                    <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#contractModal{{ contract[0] }}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <a href="{{ url_for('delete_contract', contract_id=contract[0]) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure?');">
                        <i class="fas fa-trash"></i>
                    </a>
                </td>
            </tr>
        
            <!-- Contract Details & Edit Modal -->
            <div class="modal fade" id="contractModal{{ contract[0] }}" tabindex="-1" aria-labelledby="contractModalLabel{{ contract[0] }}" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <form method="POST" action="{{ url_for('edit_contract', contract_id=contract[0]) }}" enctype="multipart/form-data">
                            <div class="modal-header">
                                <h5 class="modal-title" id="contractModalLabel{{ contract[0] }}">Contract Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <label class="form-label">Contract Name</label>
                                <input type="text" class="form-control" name="contract_name" value="{{ contract[1] }}" required>
                            
                                <label class="form-label">Supplier</label>
                                <select class="form-control" name="supplier_id" required>
                                    {% if suppliers and suppliers|length > 0 %}
                                        {% for supplier in suppliers %}
                                            <option value="{{ supplier[0] }}" {% if supplier[0] == contract[2] %}selected{% endif %}>
                                                {{ supplier[1] }}
                                            </option>
                                        {% endfor %}
                                    {% else %}
                                        <option disabled selected>No suppliers available</option>
                                    {% endif %}
                                </select>

                            
                                <label class="form-label">Start Date</label>
                                <input type="date" class="form-control" name="start_date" value="{{ contract[3] }}" required>
                            
                                <label class="form-label">End Date</label>
                                <input type="date" class="form-control" name="end_date" value="{{ contract[4] }}" required>
                            
                                <label class="form-label">Total Value (£)</label>
                                <input type="number" step="0.01" class="form-control" name="value" value="{{ contract[5] }}" required>
                            
                                <label class="form-label">Payment Frequency</label>
                                <select class="form-control" name="payment_frequency">
                                    <option value="One-time" {% if contract[6] == "One-time" %}selected{% endif %}>One-time</option>
                                    <option value="Monthly" {% if contract[6] == "Monthly" %}selected{% endif %}>Monthly</option>
                                    <option value="Quarterly" {% if contract[6] == "Quarterly" %}selected{% endif %}>Quarterly</option>
                                    <option value="Annually" {% if contract[6] == "Annually" %}selected{% endif %}>Annually</option>
                                </select>
                            
                                <!-- File Upload for Contract Documents -->
                                <label class="form-label mt-3">Upload Contract Document</label>
                                <input type="file" class="form-control" name="contract_file">
                            
                                <!-- Display Uploaded Files -->
                                {% if contract[7] %}
                                <p class="mt-2"><strong>Uploaded File:</strong> 
                                    <a href="{{ url_for('download_contract', contract_id=contract[0]) }}" target="_blank">{{ contract[7].split('/')[-1] }}</a>
                                </p>
                                {% endif %}
                            </div>
                            
                            <div class="modal-footer">
                                <button type="submit" class="btn btn-success">Save Changes</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            {% endfor %}
        </tbody>
        
    </table>
</div>

<!-- JavaScript function for table filtering -->
<script>
    function filterTable() {
        var input, filter, table, tr, td, i, j, txtValue;
        input = document.getElementById("searchInput");
        filter = input.value.toLowerCase();
        table = document.getElementById("dataTable");
        tr = table.getElementsByTagName("tr");
        
        // Loop through all table rows, skipping the header row
        for (i = 1; i < tr.length; i++) {
            tr[i].style.display = "none"; // Hide the row initially
            td = tr[i].getElementsByTagName("td");
            
            // Loop through all table cells in this row
            for (j = 0; j < td.length; j++) {
                if (td[j]) {
                    txtValue = td[j].textContent || td[j].innerText;
                    // If the cell contains the filter text, show the row
                    if (txtValue.toLowerCase().indexOf(filter) > -1) {
                        tr[i].style.display = "";
                        break;
                    }
                }
            }
        }
    }
</script>
{% endblock %}
